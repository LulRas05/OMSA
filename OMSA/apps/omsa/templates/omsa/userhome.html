{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa con Aside</title>
    <link rel="icon" href="{% static '/images/omsa-ico.png' %}">
    <link rel="stylesheet" href="{% static 'omsa/userstyle.css' %}?v=20250925-06">
    <script>
        window.OMSA_PUBLIC_ORIGIN = "http://192.168.2.6:8000";
        window.OMSA_FORCE_WA = true;
        window.OMSA_LIVE_BASE = "/api/public/live";
    </script>

    <script src="{% static 'omsa/usermap.js' %}?v=20250925-09" defer></script>
</head>
<body data-live-base="/api/public/live">
    <!-- Barra superior (Omnibox + selector de modo) -->
    <header class="topbar">
        <div class="topbar__inner">
            <div class="omnibox">
                <div class="omnibox__brand">
                    <img src="{% static 'images/LOGO-OMSA.png' %}" alt="OMSA logo">
                </div>
                <div class="omnibox__input">
                    <input class="input" id="search-box" type="text" placeholder="Buscar destino, ruta o parada‚Ä¶" />
                </div>
            </div>
            <!-- Mini-card de destino -->
            <div id="destino-card" class="destino-card" hidden>
                <div class="destino-card__title" id="destino-title">Destino</div>
                <div class="destino-card__addr" id="destino-addr"></div>
                <div class="destino-card__actions">
                    <button id="btn-go" class="btn btn--primary">Ir</button>
                    <button id="btn-change" class="btn">Cambiar</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar / Bottom-sheet -->
    <aside class="aside">
        <div class="aside__grabber" aria-hidden="true"></div>
        <nav class="tabs" role="tablist" aria-label="Panel lateral">
            <button class="tab is-active" data-tab="rutas" aria-selected="true">Rutas</button>
            <button class="tab" data-tab="cercanas" aria-selected="false">Paradas cercanas</button>
            <button class="tab" data-tab="recorrido" aria-selected="false">Recorrido</button>
            <button id="tab-reportes-btn" class="tab" data-tab="reportes" aria-selected="false"style="display:none;">Reportes</button>

        </nav>

        <section class="tabpanels">
            <!-- Buscar: reutiliza tu lista e incluir√° el panel de itinerario encima -->
            <div class="tabpanel" id="tab-recorrido" role="tabpanel" aria-labelledby="tab-recorrido-btn">
                <div id="panel-ruta" class="card card-empty" style="padding:12px">
                    <strong>Recorrido</strong>
                </div>
            </div>

            <!-- Rutas (misma lista, pero filtrada por pesta√±a si prefieres) -->
            <div class="tabpanel is-active" id="tab-rutas" role="tabpanel" aria-labelledby="tab-rutas-btn">
                <div class="rutas-filter" style="padding: 8px;">
                    <input id="rutas-search" class="input" type="text" placeholder="Buscar rutas/paradas" />
                </div>
                <ul id="lista-rutas-rutas"></ul>
            </div>

            <!-- Paradas cercanas: se llena con JS usando el √≠ndice -->
            <div class="tabpanel" id="tab-cercanas" role="tabpanel" aria-labelledby="tab-cercanas-btn">
                <ul id="nearby-stops" class="nearby"></ul>
            </div>

            <div class="tabpanel" id="tab-reportes" role="tabpanel" aria-labelledby="tab-reportes-btn" style="display:none;">
                <div id="panel-reportes" class="card card-empty" style="padding:12px">
                    <strong>Reportes</strong>
                    <p id="reportes-placeholder" class="muted" style="margin-top:6px;">
                        Fija un destino para poder enviar un reporte.
                    </p>

                    <!-- Aqu√≠ ir√° el formulario en la Subtarea 2 -->
                    <div id="reportes-form-wrap" style="display:none;">
                        <div class="reportes-row" style="margin-top:8px">
                            <label class="label" for="reporte-tipo" style="display:block;margin-bottom:4px">Tipo de reporte</label>
                            <select id="reporte-tipo" class="input" style="width:100%; padding: 8px;">
                                <option value="">‚Äî Selecciona ‚Äî</option>
                                <option value="robo">Robo</option>
                                <option value="objeto_perdido">Objeto perdido</option>
                                <option value="conduccion_temeraria">Conducci√≥n temeraria</option>
                                <option value="sugerencia">Sugerencias</option>
                            </select>
                        </div>

                        <div class="reportes-row" style="margin-top:10px">
                            <label class="label" for="reporte-texto" style="display:block;margin-bottom:4px">
                                Descripci√≥n <span class="muted">(m√°x. 40 caracteres)</span>
                            </label>
                            <textarea id="reporte-texto" rows="3" class="input" maxlength="40" placeholder="..." style="width:100%"></textarea>
                            <div class="help" id="reporte-help" style="opacity:.75;margin-top:4px">
                                <span id="reporte-cont">0</span>/40
                            </div>
                        </div>

                        <div class="reportes-row" style="margin-top:10px;display:flex;gap:8px;align-items:center">
                            <button id="reporte-enviar" class="btn btn--primary" disabled>Enviar</button>
                            <span id="reporte-msg" class="muted" aria-live="polite"></span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </aside>

    <!-- Mapa -->
    <main id="map"></main>

    <!-- FABs flotantes -->
    <div class="fabs">
        <button id="fab-my-location" class="fab" title="Mi ubicaci√≥n">üìç</button>
        <button id="fab-set-origin-hint" class="fab" title="Fijar origen (Shift + clic)">‚õ≥</button>
        <button id="fab-clear-map" class="fab" title="Limpiar">üßπ</button>
    </div>

    <!-- Leyenda -->
    <div class="legend">
        <span class="legend__dot legend__dot--walk"></span> Caminar
        <span class="legend__dot legend__dot--bus"></span> Ruta OMSA
        <span class="legend__dot legend__dot--me"></span> Mi ubicaci√≥n
    </div>

    <!-- Carga moderna de Google Maps -->
    <script>
        (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
            key: "AIzaSyCl8SfPwcJc8Nl-rmAXhI8G8aPxC56tSJU",
            v: "weekly",
        });
    </script>
</body>
</html>
